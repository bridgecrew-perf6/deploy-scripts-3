
name: Deployment job

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string
      image:
        required: true
        type: string
      target:
        required: true
        type: string
      runner:
        required: false
        default: 'dev-runner'
        type: string
    secrets:
      token:
        required: true
      dotoken:
        required: true

env:
  IMAGE: ${{ inputs.image }}
  SERVICE: ${{ inputs.service }}
  TARGET: ${{ inputs.target }}

jobs:
  deploy:
    runs-on: ${{ inputs.runner }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          repository: vimalsudhanorg/infra
          ref: master
          path: __infra
          token: ${{ secrets.token }}

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.dotoken }} 

      - name: Update deployment file
        run: sed -i 's|<IMAGE>|'${IMAGE}'|' $GITHUB_WORKSPACE/__infra/services/$SERVICE/spec.yml
      
      - name: Debug deployment file
        run: cat $GITHUB_WORKSPACE/__infra/services/$SERVICE/spec.yml

      - name: Get cluster Configs
        id: getClusterConfigs
        run: |
          cd $GITHUB_WORKSPACE/__infra
          ./scripts/getconfig.sh

      - name: Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ steps.getClusterConfigs.outputs.cluster-id }}

      - name: Deploy to DigitalOcean Kubernetes
        run: kubectl apply -f $GITHUB_WORKSPACE/__infra/services/$SERVICE/spec.yml

      - name: Verify deployment
        run: kubectl rollout status deployment/github-runner
